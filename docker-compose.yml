services:
  zaibridge:
    build: .
    container_name: zaibridge
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      # 数据库配置
      - DATABASE_URI=sqlite:////app/instance/zai2api.db
      # Flask 安全配置
      - SECRET_KEY=${SECRET_KEY:-change_this_to_a_random_string_in_production}
      # 时区配置
      - TZ=Asia/Shanghai
      # 日志级别
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Token 刷新间隔（秒）
      - TOKEN_REFRESH_INTERVAL=${TOKEN_REFRESH_INTERVAL:-3600}
      # 错误重试次数
      - ERROR_RETRY_COUNT=${ERROR_RETRY_COUNT:-3}
      # 错误封禁阈值
      - ERROR_BAN_THRESHOLD=${ERROR_BAN_THRESHOLD:-3}
      # 代理配置（可选）
      - PROXY_ENABLED=${PROXY_ENABLED:-false}
      - PROXY_URL=${PROXY_URL:-}
      # 缓存配置
      - CACHE_ENABLED=${CACHE_ENABLED:-false}
      - CACHE_TIMEOUT=${CACHE_TIMEOUT:-300}
      - CACHE_BASE_URL=${CACHE_BASE_URL:-}
      # 流式转换
      - STREAM_CONVERSION_ENABLED=${STREAM_CONVERSION_ENABLED:-false}
      # 生成超时
      - IMAGE_TIMEOUT=${IMAGE_TIMEOUT:-120}
      - VIDEO_TIMEOUT=${VIDEO_TIMEOUT:-600}
    volumes:
      - ./instance:/app/instance
      - ./logs:/app/logs
    networks:
      - zaibridge-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

networks:
  zaibridge-network:
    driver: bridge
    external: false
